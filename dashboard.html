<script>
async function loadDashboard() {
  const user = JSON.parse(localStorage.getItem("user"));

  if (!user || !user.studentid) {
    console.log("Student not found");
    return;
  }

  try {
    const res = await fetch(
      `https://backend-deployment-11.onrender.com/student/${user.studentid}`
    );

    const data = await res.json();
    if (!data) return;

    document.getElementById("name").innerText = data.name;
    document.getElementById("attendance").innerText = data.attendance;
    document.getElementById("attBox").innerText = data.attendance;

    let marks = data.marks ?? {};
    let subjects = Object.keys(marks);
    let values = Object.values(marks).map(v => Number(v));

    document.getElementById("subBox").innerText = subjects.length;

    let avg = 0;
    if (subjects.length > 0) {
      let total = values.reduce((a, v) => a + v, 0);
      avg = Math.round(total / subjects.length);
    }

    document.getElementById("avgBox").innerText = avg;

    if (subjects.length > 0) {
      const ctx = document.getElementById("marksChart");

      new Chart(ctx, {
        type: "bar",
        data: {
          labels: subjects,
          datasets: [{
            label: "Marks",
            data: values,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { beginAtZero: true, max: 100 }
          }
        }
      });
    }

  } catch (err) {
    console.log("Dashboard load failed", err);
  }
}

loadDashboard();
</script>
