<script>
let chartInstance = null;

async function loadDashboard() {
  const user = JSON.parse(localStorage.getItem("user"));
  if (!user) return;

  const sid = user.studentid || user.studentId || user.id;

  const res = await fetch(`${API_BASE}/student/${sid}`);
  const data = await res.json();

  document.getElementById("name").innerText = data.name;
  document.getElementById("attendance").innerText = data.attendance;
  document.getElementById("attBox").innerText = data.attendance;

  const marks = data.marks || {};
  const subjects = Object.keys(marks);
  const values = Object.values(marks).map(v => Number(v) || 0);

  document.getElementById("subBox").innerText = subjects.length;

  let avg = 0;
  if (subjects.length > 0) {
    avg = Math.round(values.reduce((a, v) => a + v, 0) / subjects.length);
  }

  document.getElementById("avgBox").innerText = avg;

  if (chartInstance) chartInstance.destroy();

  if (subjects.length > 0) {
    const ctx = document.getElementById("marksChart").getContext("2d");

    chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: subjects,
        datasets: [{
          label: "Marks",
          data: values,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, max: 100 }
        }
      }
    });
  }
}

loadDashboard();
</script>
